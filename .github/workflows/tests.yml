name: concert tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master, decentralize]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
      fail-fast: false

    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Print python version
        run: python -c "import sys; print(sys.version)"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest coverage scikit-image mypy pytango
          pip install .
      - name: Partial Type-Check
        if: matrix.python-version == 3.8
        run: make type-check
      - name: SpinUp Tango Control Server
        if: matrix.python-version == 3.8
        run: make tango-service-up
      - name: Wait For Tango Control Server
        if: matrix.python-version == 3.8
        uses: whatnick/wait-action@master
        with:
          time: '10s'
      - name: Register Tango Device, Run Server and Execute Test
        if: matrix.python-version == 3.8
        run: |
          docker container ls
          export TANGO_HOST=127.0.0.1:8090
          python concert/tests/integration/tango/dev_reg.py
          bash --rcfile <(echo '. ~/.bashrc; python concert/tests/integration/tango/power_supply.py test')
          make check-tango
      - name: Teardown Tango Service
        if: matrix.python-version == 3.8
        run: |
          unset TANGO_HOST
          make tango-service-down
      # TODO: Investigate why the composite action is not being executed
      # - name: Checkout before using Tango service action
      #   uses: actions/checkout@v3
      # - name: Execute Tango TestCase
      #   uses: ./.github/actions/tango-service-test
      - name: Test with pytest
        run: |
          coverage run --source=concert -m pytest -m "not skip_ci" --ignore concert/tests/integration/tango
      - name: Upload coverage to Codecov
        if: matrix.python-version == 3.8
        uses: codecov/codecov-action@v2
        with:
          fail_ci_if_error: true
          verbose: true
